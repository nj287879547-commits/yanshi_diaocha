<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>小学生岩石观察记录系统（多端实时版）</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial Rounded MT Bold','Segoe UI',sans-serif}
    :root{--primary:#4a6fa5;--secondary:#6bbf59;--accent:#ff9e4a;--light:#f5f7fa;--dark:#2c3e50;--shadow:0 4px 6px rgba(0,0,0,.1)}
    body{background:linear-gradient(135deg,#e0f7fa 0%,#bbdefb 100%);color:var(--dark);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{text-align:center;margin-bottom:30px;padding:20px;background:#fff;border-radius:15px;box-shadow:var(--shadow)}
    h1{color:var(--primary);margin-bottom:10px;font-size:2.5rem}
    .subtitle{color:var(--dark);font-size:1.2rem}
    .tab-container{display:flex;justify-content:center;margin-bottom:30px}
    .tab{padding:15px 30px;background:#fff;border:none;border-radius:10px 10px 0 0;font-size:1.2rem;font-weight:bold;cursor:pointer;transition:.3s;box-shadow:var(--shadow);margin:0 5px}
    .tab.active{background:var(--primary);color:#fff}
    .tab-content{display:none;background:#fff;border-radius:15px;padding:30px;box-shadow:var(--shadow);min-height:500px}
    .tab-content.active{display:block}
    .student-form{max-width:800px;margin:0 auto}
    .form-title{color:var(--primary);margin-bottom:15px;display:flex;align-items:center}
    .form-title i{margin-right:10px;font-size:1.5rem}
    .instruction{text-align:center;margin-bottom:20px;font-size:1.2rem;color:var(--dark);background:var(--light);padding:15px;border-radius:10px}
    .observation-pair{display:flex;gap:15px;margin-bottom:15px;align-items:center}
    .observation-input{flex:1;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1.1rem}
    .observation-input:focus{border-color:var(--primary);outline:none}
    .pair-submit-btn{padding:12px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;white-space:nowrap}
    .pair-submit-btn:hover{background:#ff8a2a;transform:scale(1.05)}
    .pair-container{margin-bottom:25px;padding:20px;background:var(--light);border-radius:10px}
    .pair-title{color:var(--primary);margin-bottom:10px;font-size:1.2rem}
    .teacher-dashboard{max-width:1000px;margin:0 auto}
    .teacher-controls{display:flex;justify-content:flex-end;gap:15px;margin-bottom:20px}
    .teacher-btn{padding:10px 20px;background:var(--light);border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .teacher-btn:hover{transform:translateY(-2px)}
    .refresh-btn{color:var(--primary)}
    .clear-btn{color:#e74c3c}
    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .stat-card{background:var(--light);border-radius:10px;padding:20px;text-align:center;box-shadow:var(--shadow)}
    .stat-value{font-size:2.5rem;font-weight:bold;color:var(--primary);margin:10px 0}
    .analysis-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .analysis-card{background:#fff;border-radius:10px;padding:20px;box-shadow:var(--shadow)}
    .analysis-title{color:var(--primary);margin-bottom:15px;text-align:center}
    .item-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .common-item{background:var(--secondary);color:#fff;padding:8px 15px;border-radius:20px;font-size:1rem}
    .unique-item{background:var(--accent);color:#fff;padding:8px 15px;border-radius:20px;font-size:1rem}
    .records-list{background:#fff;border-radius:10px;padding:20px;box-shadow:var(--shadow)}
    .record-item{padding:15px;border-bottom:1px solid #eee}
    .record-item:last-child{border-bottom:none}
    .no-data{text-align:center;padding:40px;color:#666;font-size:1.2rem}
    .status-message{text-align:center;padding:10px;margin:10px 0;border-radius:5px;font-weight:bold}
    .success{background:#d4edda;color:#155724}
    .error{background:#f8d7da;color:#721c24}
    @media (max-width:768px){
      .stats-container,.analysis-container{grid-template-columns:1fr}
      .tab{padding:12px 20px;font-size:1rem}
      .teacher-controls{justify-content:center}
      .observation-pair{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-gem"></i> 岩石观察记录系统</h1>
      <p class="subtitle">探索岩石的奥秘，记录我们的发现（云端实时版）</p>
    </header>

    <div class="tab-container">
      <button class="tab active" data-tab="student">学生填写</button>
      <button class="tab" data-tab="teacher">教师查看</button>
    </div>

    <!-- 学生填写 -->
    <div id="student" class="tab-content active">
      <div class="student-form">
        <h2 class="form-title"><i class="fas fa-search"></i> 我的岩石观察记录</h2>
        <div class="instruction">请填写你打算用什么方法观察岩石的什么特征</div>

        <div class="pair-container">
          <div class="pair-title">观察记录 1</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method1" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect1" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="1">提交</button>
          </div>
        </div>

        <div class="pair-container">
          <div class="pair-title">观察记录 2</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method2" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect2" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="2">提交</button>
          </div>
        </div>

        <div class="pair-container">
          <div class="pair-title">观察记录 3</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method3" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect3" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="3">提交</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 教师查看 -->
    <div id="teacher" class="tab-content">
      <div class="teacher-dashboard">
        <div class="teacher-controls">
          <button class="teacher-btn refresh-btn" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> 刷新数据
          </button>
          <button class="teacher-btn clear-btn" id="clear-btn">
            <i class="fas fa-trash-alt"></i> 清空数据
          </button>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-title">共性方法</div>
            <div class="stat-value" id="common-methods-count">0</div>
            <div class="stat-desc">常用观察方法</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">共性特征</div>
            <div class="stat-value" id="common-aspects-count">0</div>
            <div class="stat-desc">常用观察特征</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">总提交数</div>
            <div class="stat-value" id="total-submissions">0</div>
            <div class="stat-desc">观察记录</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">今日提交</div>
            <div class="stat-value" id="today-submissions">0</div>
            <div class="stat-desc">观察记录</div>
          </div>
        </div>

        <div class="analysis-container">
          <div class="analysis-card">
            <h3 class="analysis-title">方法分析</h3>
            <h4>共性方法</h4>
            <div class="item-list" id="common-methods"></div>
            <h4 style="margin-top:15px;">个性方法</h4>
            <div class="item-list" id="unique-methods"></div>
          </div>

          <div class="analysis-card">
            <h3 class="analysis-title">特征分析</h3>
            <h4>共性特征</h4>
            <div class="item-list" id="common-aspects"></div>
            <h4 style="margin-top:15px;">个性特征</h4>
            <div class="item-list" id="unique-aspects"></div>
          </div>
        </div>

        <div class="records-list">
          <h3 class="analysis-title">最新观察记录</h3>
          <div id="records-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 实时后端：Firebase Firestore（模块版 SDK） -->
  <script type="module">
    /************ 1) 初始化 Firebase ************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot, getDocs, deleteDoc, doc,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // TODO: 填写你的 Firebase 配置（从 Firebase 控制台拷贝）
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 可选：启用离线缓存（浏览器内部仍使用 IndexedDB 做缓存）
    enableIndexedDbPersistence(db).catch((err) => {
      // 多 tab 冲突等情况会失败，不影响在线可用
      console.warn("IndexedDB 持久化不可用：", err?.code || err);
    });

    // 全局集合引用
    const colRef = collection(db, "observations");

    /************ 2) UI：标签切换 ************/
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    /************ 3) 学生端：提交记录（写云端） ************/
    document.querySelectorAll('.pair-submit-btn').forEach(btn=>{
      btn.addEventListener('click', async function(e){
        e.preventDefault();
        const n = this.getAttribute('data-pair');
        const methodInput = document.getElementById(`method${n}`);
        const aspectInput = document.getElementById(`aspect${n}`);

        const method = (methodInput.value || "").trim();
        const aspect = (aspectInput.value || "").trim();

        if(!method){ alert('请填写观察方法！'); methodInput.focus(); return; }
        if(!aspect){ alert('请填写观察特征！'); aspectInput.focus(); return; }

        const now = new Date();
        const record = {
          method,
          aspect,
          date: now.toLocaleDateString('zh-CN'),
          // 以服务器时间为准，保证各端一致性
          timestamp: serverTimestamp(),
          createdAt: serverTimestamp()
        };

        showStatus('正在提交数据...', 'success');
        try{
          await addDoc(colRef, record);
          showStatus('提交成功！数据已保存到云端并实时同步', 'success');
          // 可选：清空输入
          methodInput.value = '';
          aspectInput.value = '';
        }catch(err){
          console.error('提交失败：', err);
          showStatus('提交失败，请检查网络后重试。', 'error');
        }
        setTimeout(clearStatus, 3000);
      });
    });

    /************ 4) 教师端：实时订阅云端变化 ************/
    // 订阅整个集合的变化（按时间倒序）
    const q = query(colRef, orderBy('timestamp','desc'));
    let unsubscribe = null;

    function startRealtimeSubscription(){
      if (unsubscribe) return; // 避免重复订阅
      unsubscribe = onSnapshot(q, (snapshot)=>{
        const records = snapshot.docs.map(d=>{
          const data = d.data();
          // 兼容服务器时间戳未写入前的瞬间状态
          const millis = data.timestamp?.toMillis ? data.timestamp.toMillis() : 0;
          return { id: d.id, ...data, timestamp: millis };
        });
        updateTeacherDashboard(records);
      }, (error)=>{
        console.error('实时订阅失败：', error);
        showStatus('实时数据订阅失败，请刷新或重试', 'error');
        setTimeout(clearStatus, 3000);
      });
    }

    // 默认直接开启订阅（无论在哪个标签页，都能保持最新）
    startRealtimeSubscription();

    /************ 5) 教师端：按钮动作 ************/
    document.getElementById('refresh-btn').addEventListener('click', async ()=>{
      // 手动刷新一次（通常不需要，因为有 onSnapshot）
      const snapshot = await getDocs(q);
      const records = snapshot.docs.map(d=>{
        const data = d.data();
        const millis = data.timestamp?.toMillis ? data.timestamp.toMillis() : 0;
        return { id: d.id, ...data, timestamp: millis };
      });
      updateTeacherDashboard(records);
      showStatus('数据已刷新！', 'success');
      setTimeout(clearStatus, 3000);
    });

    document.getElementById('clear-btn').addEventListener('click', async ()=>{
      if(!confirm('确定要清空所有学生提交的记录吗？此操作不可恢复！')) return;
      showStatus('正在清空数据...', 'success');
      try{
        const snapshot = await getDocs(colRef);
        // Firestore 没有一次性清空集合的 API，逐条删除
        await Promise.all(snapshot.docs.map(docSnap => deleteDoc(doc(db, 'observations', docSnap.id))));
        showStatus('所有记录已清空！', 'success');
      }catch(err){
        console.error('清空失败：', err);
        showStatus('清空失败，请重试。', 'error');
      }
      setTimeout(clearStatus, 3000);
    });

    /************ 6) 统计与分析（沿用你原先的逻辑） ************/
    function updateTeacherDashboard(records){
      const dashboard = document.querySelector('.teacher-dashboard');
      if(!records || records.length === 0){
        dashboard.innerHTML = `
          <div class="teacher-controls">
            <button class="teacher-btn refresh-btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
            <button class="teacher-btn clear-btn" id="clear-btn"><i class="fas fa-trash-alt"></i> 清空数据</button>
          </div>
          <div class="no-data">
            <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <p>暂无学生提交的观察记录</p>
            <p style="margin-top: 10px; font-size: 1rem;">请切换到学生界面填写观察记录</p>
          </div>
        `;
        // 重新绑定按钮事件
        document.getElementById('refresh-btn').addEventListener('click', async ()=>{
          const snapshot = await getDocs(q);
          const rs = snapshot.docs.map(d=>{
            const data = d.data();
            const millis = data.timestamp?.toMillis ? data.timestamp.toMillis() : 0;
            return { id: d.id, ...data, timestamp: millis };
          });
          updateTeacherDashboard(rs);
          showStatus('数据已刷新！', 'success');
          setTimeout(clearStatus, 3000);
        });
        document.getElementById('clear-btn').addEventListener('click', async ()=>{
          if(!confirm('确定要清空所有学生提交的记录吗？此操作不可恢复！')) return;
          showStatus('正在清空数据...', 'success');
          try{
            const snapshot = await getDocs(colRef);
            await Promise.all(snapshot.docs.map(docSnap => deleteDoc(doc(db, 'observations', docSnap.id))));
            showStatus('所有记录已清空！', 'success');
          }catch(err){
            console.error('清空失败：', err);
            showStatus('清空失败，请重试。', 'error');
          }
          setTimeout(clearStatus, 3000);
        });
        return;
      }

      // 更新统计卡片
      document.getElementById('total-submissions').textContent = records.length;
      document.getElementById('today-submissions').textContent = getTodaySubmissions(records);

      const { commonMethods, uniqueMethods, commonAspects, uniqueAspects } = analyzeRecords(records);
      document.getElementById('common-methods-count').textContent = commonMethods.length;
      document.getElementById('common-aspects-count').textContent = commonAspects.length;

      updateAnalysisResults(commonMethods, uniqueMethods, commonAspects, uniqueAspects);
      updateRecordsList(records);
    }

    function getTodaySubmissions(records){
      const today = new Date().toLocaleDateString('zh-CN');
      return records.filter(r => r.date === today).length;
    }

    function analyzeRecords(records){
      const allMethods = [];
      const allAspects = [];
      records.forEach(r=>{
        if (r.method) allMethods.push(String(r.method));
        if (r.aspect) allAspects.push(String(r.aspect));
      });
      const methodCounts = countAndGroupSimilarItems(allMethods);
      const aspectCounts = countAndGroupSimilarItems(allAspects);

      const commonMethods = Object.entries(methodCounts).filter(([,c])=>c>=3).map(([item,count])=>({item,count}));
      const uniqueMethods = Object.entries(methodCounts).filter(([,c])=>c<3).map(([item,count])=>({item,count}));
      const commonAspects = Object.entries(aspectCounts).filter(([,c])=>c>=3).map(([item,count])=>({item,count}));
      const uniqueAspects = Object.entries(aspectCounts).filter(([,c])=>c<3).map(([item,count])=>({item,count}));

      return { commonMethods, uniqueMethods, commonAspects, uniqueAspects };
    }

    function countAndGroupSimilarItems(items){
      const counts = {};
      items.forEach(raw=>{
        const normalized = raw.trim().toLowerCase();
        let found = false;
        for(const key in counts){
          if(isSimilar(normalized, key)){ counts[key]++; found = true; break; }
        }
        if(!found) counts[normalized] = 1;
      });
      return counts;
    }

    function isSimilar(a,b){
      if(a===b) return true;
      if(a.includes(b) || b.includes(a)) return true;
      const d = levenshtein(a,b);
      const L = Math.max(a.length,b.length) || 1;
      return d <= L/3;
    }

    function levenshtein(a,b){
      const m = [];
      for(let i=0;i<=b.length;i++){ m[i]=[i]; }
      for(let j=0;j<=a.length;j++){ m[0][j]=j; }
      for(let i=1;i<=b.length;i++){
        for(let j=1;j<=a.length;j++){
          m[i][j] = (b[i-1]===a[j-1])
            ? m[i-1][j-1]
            : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
        }
      }
      return m[b.length][a.length];
    }

    function updateAnalysisResults(commonMethods, uniqueMethods, commonAspects, uniqueAspects){
      const cm = document.getElementById('common-methods'); cm.innerHTML = commonMethods.length? '' : '<p style="color:#666;text-align:center;">暂无共性方法</p>';
      const um = document.getElementById('unique-methods'); um.innerHTML = uniqueMethods.length? '' : '<p style="color:#666;text-align:center;">暂无个性方法</p>';
      const ca = document.getElementById('common-aspects'); ca.innerHTML = commonAspects.length? '' : '<p style="color:#666;text-align:center;">暂无共性特征</p>';
      const ua = document.getElementById('unique-aspects'); ua.innerHTML = uniqueAspects.length? '' : '<p style="color:#666;text-align:center;">暂无个性特征</p>';

      commonMethods.forEach(x=>{ const el=document.createElement('div'); el.className='common-item'; el.textContent=`${x.item} (${x.count})`; cm.appendChild(el); });
      uniqueMethods.forEach(x=>{ const el=document.createElement('div'); el.className='unique-item'; el.textContent=`${x.item} (${x.count})`; um.appendChild(el); });
      commonAspects.forEach(x=>{ const el=document.createElement('div'); el.className='common-item'; el.textContent=`${x.item} (${x.count})`; ca.appendChild(el); });
      uniqueAspects.forEach(x=>{ const el=document.createElement('div'); el.className='unique-item'; el.textContent=`${x.item} (${x.count})`; ua.appendChild(el); });
    }

    function updateRecordsList(records){
      const container = document.getElementById('records-container');
      container.innerHTML = '';
      if(!records.length){
        container.innerHTML = '<p style="text-align:center;padding:20px;">暂无学生提交记录</p>';
        return;
      }
      // 按时间倒序（firestore 查询已倒序，但这里再保险）
      records.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
      const recent = records.slice(0,10);
      recent.forEach(r=>{
        const el = document.createElement('div');
        el.className='record-item';
        const dateStr = r.date || '—';
        el.innerHTML = `
          <div class="record-date"><strong>提交时间:</strong> ${dateStr}</div>
          <div class="record-methods"><strong>观察方法:</strong> ${escapeHtml(r.method||'')}</div>
          <div class="record-aspects"><strong>观察特征:</strong> ${escapeHtml(r.aspect||'')}</div>
        `;
        container.appendChild(el);
      });
      if(records.length>10){
        const more=document.createElement('div');
        more.className='record-item'; more.style.textAlign='center'; more.style.color='#666';
        more.textContent = `还有 ${records.length-10} 条记录未显示`;
        container.appendChild(more);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }

    /************ 7) 状态提示 ************/
    function showStatus(message,type){
      clearStatus();
      const el = document.createElement('div');
      el.className = `status-message ${type}`;
      el.textContent = message;
      el.id = 'status-message';
      document.querySelector('.container').insertBefore(el, document.querySelector('.tab-container'));
    }
    function clearStatus(){
      const el = document.getElementById('status-message');
      if(el) el.remove();
    }
  </script>
</body>
</html>
