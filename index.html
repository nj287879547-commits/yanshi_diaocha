<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>岩石观察记录系统（多端实时版）</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial Rounded MT Bold','Segoe UI',sans-serif}
    :root{--primary:#4a6fa5;--secondary:#6bbf59;--accent:#ff9e4a;--light:#f5f7fa;--dark:#2c3e50;--shadow:0 4px 6px rgba(0,0,0,.1)}
    body{background:linear-gradient(135deg,#e0f7fa 0%,#bbdefb 100%);color:var(--dark);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{text-align:center;margin-bottom:30px;padding:20px;background:#fff;border-radius:15px;box-shadow:var(--shadow)}
    h1{color:var(--primary);margin-bottom:10px;font-size:2.5rem}
    .subtitle{color:var(--dark);font-size:1.2rem}
    .tab-container{display:flex;justify-content:center;margin-bottom:30px}
    .tab{padding:15px 30px;background:#fff;border:none;border-radius:10px 10px 0 0;font-size:1.2rem;font-weight:bold;cursor:pointer;transition:.3s;box-shadow:var(--shadow);margin:0 5px}
    .tab.active{background:var(--primary);color:#fff}
    .tab-content{display:none;background:#fff;border-radius:15px;padding:30px;box-shadow:var(--shadow);min-height:500px}
    .tab-content.active{display:block}
    .student-form{max-width:800px;margin:0 auto}
    .form-title{color:var(--primary);margin-bottom:15px;display:flex;align-items:center}
    .form-title i{margin-right:10px;font-size:1.5rem}
    .instruction{text-align:center;margin-bottom:20px;font-size:1.2rem;color:var(--dark);background:var(--light);padding:15px;border-radius:10px}
    .observation-pair{display:flex;gap:15px;margin-bottom:15px;align-items:center}
    .observation-input{flex:1;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1.1rem}
    .observation-input:focus{border-color:var(--primary);outline:none}
    .pair-submit-btn{padding:12px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;white-space:nowrap}
    .pair-submit-btn:hover{background:#ff8a2a;transform:scale(1.05)}
    .pair-container{margin-bottom:25px;padding:20px;background:var(--light);border-radius:10px}
    .pair-title{color:var(--primary);margin-bottom:10px;font-size:1.2rem}
    .teacher-dashboard{max-width:1000px;margin:0 auto}
    .teacher-controls{display:flex;justify-content:flex-end;gap:15px;margin-bottom:20px}
    .teacher-btn{padding:10px 20px;background:var(--light);border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .teacher-btn:hover{transform:translateY(-2px)}
    .refresh-btn{color:var(--primary)}
    .clear-btn{color:#e74c3c}
    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .stat-card{background:var(--light);border-radius:10px;padding:20px;text-align:center;box-shadow:var(--shadow)}
    .stat-value{font-size:2.5rem;font-weight:bold;color:var(--primary);margin:10px 0}
    .analysis-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .analysis-card{background:#fff;border-radius:10px;padding:20px;box-shadow:var(--shadow)}
    .analysis-title{color:var(--primary);margin-bottom:15px;text-align:center}
    .item-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .common-item{background:var(--secondary);color:#fff;padding:8px 15px;border-radius:20px;font-size:1rem}
    .unique-item{background:var(--accent);color:#fff;padding:8px 15px;border-radius:20px;font-size:1rem}
    .records-list{background:#fff;border-radius:10px;padding:20px;box-shadow:var(--shadow)}
    .record-item{padding:15px;border-bottom:1px solid #eee}
    .record-item:last-child{border-bottom:none}
    .no-data{text-align:center;padding:40px;color:#666;font-size:1.2rem}
    .status-message{text-align:center;padding:10px;margin:10px 0;border-radius:5px;font-weight:bold}
    .success{background:#d4edda;color:#155724}
    .error{background:#f8d7da;color:#721c24}
    @media (max-width:768px){
      .stats-container,.analysis-container{grid-template-columns:1fr}
      .tab{padding:12px 20px;font-size:1rem}
      .teacher-controls{justify-content:center}
      .observation-pair{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-gem"></i>方法特征记录系统</h1>
      <p class="subtitle">探索岩石的奥秘，记录我们的发现</p>
    </header>

    <div class="tab-container">
      <button class="tab active" data-tab="student">学生填写</button>
      <button class="tab" data-tab="teacher">教师查看</button>
    </div>

    <!-- 学生填写 -->
    <div id="student" class="tab-content active">
      <div class="student-form">
        <h2 class="form-title"><i class="fas fa-search"></i>我的岩石思考记录</h2>
        <div class="instruction">请填写你打算用什么方法观察岩石的什么特征</div>

        <div class="pair-container">
          <div class="pair-title">观察记录 1</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method1" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect1" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="1">提交</button>
          </div>
        </div>

        <div class="pair-container">
          <div class="pair-title">观察记录 2</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method2" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect2" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="2">提交</button>
          </div>
        </div>

        <div class="pair-container">
          <div class="pair-title">观察记录 3</div>
          <div class="observation-pair">
            <input type="text" class="observation-input" id="method3" placeholder="用什么方法">
            <input type="text" class="observation-input" id="aspect3" placeholder="观察什么特征">
            <button class="pair-submit-btn" data-pair="3">提交</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 教师查看 -->
    <div id="teacher" class="tab-content">
      <div class="teacher-dashboard">
        <div class="teacher-controls">
          <button class="teacher-btn refresh-btn" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> 刷新数据
          </button>
          <button class="teacher-btn clear-btn" id="clear-btn">
            <i class="fas fa-trash-alt"></i> 清空数据
          </button>
        </div>

        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-title">共性方法</div>
            <div class="stat-value" id="common-methods-count">0</div>
            <div class="stat-desc">常用观察方法</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">共性特征</div>
            <div class="stat-value" id="common-aspects-count">0</div>
            <div class="stat-desc">常用观察特征</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">总提交数</div>
            <div class="stat-value" id="total-submissions">0</div>
            <div class="stat-desc">观察记录</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">今日提交</div>
            <div class="stat-value" id="today-submissions">0</div>
            <div class="stat-desc">观察记录</div>
          </div>
        </div>

        <div class="analysis-container">
          <div class="analysis-card">
            <h3 class="analysis-title">方法</h3>
            <div class="item-list" id="common-methods"></div>
            <div class="item-list" id="unique-methods"></div>
          </div>

          <div class="analysis-card">
            <h3 class="analysis-title">特征</h3>
            <div class="item-list" id="common-aspects"></div>
            <div class="item-list" id="unique-aspects"></div>
          </div>
        </div>

        <div class="records-list">
          <h3 class="analysis-title">最新观察记录</h3>
          <div id="records-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 实时后端：Firebase Firestore（模块版 SDK） -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // 1) 用你的项目参数替换下面两项
  const SUPABASE_URL = "https://fdgprrtllwycykgulbnz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZ3BycnRsbHd5Y3lrZ3VsYm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Mjg4MDksImV4cCI6MjA3ODEwNDgwOX0.tWyXbTgj9XnKcFqo9qmKw-u6WRTJoGBCkDswi3ZwBRU";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 2) 标签切换（保留你的逻辑）
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

 // 3) 学生端提交：insert
  document.querySelectorAll('.pair-submit-btn').forEach(btn=>{
    btn.addEventListener('click', async function(e){
      e.preventDefault();

      // 如果按钮已经禁用，直接返回
      if (this.disabled) return;
      const n=this.getAttribute('data-pair');
      const methodInput=document.getElementById(`method${n}`);
      const aspectInput=document.getElementById(`aspect${n}`);
      const method=(methodInput.value||'').trim();
      const aspect=(aspectInput.value||'').trim();
      if(!method){ alert('请填写观察方法！'); methodInput.focus(); return; }
      if(!aspect){ alert('请填写观察特征！'); aspectInput.focus(); return; }

      // 立即禁用按钮
      this.disabled = true;
      this.style.opacity = '0.6';
      this.style.cursor = 'not-allowed';

      showStatus('正在提交数据...', 'success');
      try{
        const now=Date.now();
        const { error } = await supabase.from('observations').insert({
          method, aspect,
          date: new Date(now).toLocaleDateString('zh-CN'),
          timestamp: now
        });
        if(error) throw error;
        showStatus('提交成功！多端已同步', 'success');
      }catch(err){
        console.error(err);
        showStatus('提交失败，请检查网络/策略', 'error');
        // 如果提交失败，重新启用按钮
        this.disabled = false;
        this.style.opacity = '1';
        this.style.cursor = 'pointer';
      }
      setTimeout(clearStatus, 2500);
    });
  });

  // 4) 清空（批量删除）
  document.getElementById('clear-btn').addEventListener('click', async ()=>{
    if(!confirm('确定要清空所有记录吗？')) return;
    showStatus('正在清空数据...', 'success');
    try{
      const { error } = await supabase.from('observations')
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000'); // 防止空 where
      if(error) throw error;
      showStatus('已清空', 'success');
    }catch(err){
      console.error(err);
      showStatus('清空失败', 'error');
    }
    setTimeout(clearStatus, 2500);
  });

  // 5) 首次加载 + Realtime 订阅
  await fetchAndRender();

  const channel = supabase
    .channel('obs-change')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'observations' }, () => {
      fetchAndRender(); // 量小场景用全量刷新最简单可靠
    })
    .subscribe();

  async function fetchAndRender(){
    const { data, error } = await supabase
      .from('observations')
      .select('*')
      .order('timestamp', { ascending: false });
    if(error){
      console.error(error);
      showStatus('加载失败', 'error');
      setTimeout(clearStatus, 2500);
      return;
    }
    updateTeacherDashboard(data||[]);
  }

  // 6) 手动刷新按钮
  document.getElementById('refresh-btn').addEventListener('click', fetchAndRender);

  // ========= 以下沿用你现有的函数，无需修改 =========
  function updateTeacherDashboard(records){
    const dash = document.querySelector('.teacher-dashboard');
    if(!records || !records.length){
      dash.querySelector('#total-submissions').textContent = 0;
      dash.querySelector('#today-submissions').textContent = 0;
      dash.querySelector('#common-methods-count').textContent = 0;
      dash.querySelector('#common-aspects-count').textContent = 0;
      ['common-methods','unique-methods','common-aspects','unique-aspects','records-container']
        .forEach(id=> document.getElementById(id).innerHTML = '');
      document.getElementById('records-container').innerHTML = '<p style="text-align:center;padding:20px;">暂无学生提交记录</p>';
      return;
    }
    document.getElementById('total-submissions').textContent = records.length;
    document.getElementById('today-submissions').textContent = getTodaySubmissions(records);
    const { commonMethods, uniqueMethods, commonAspects, uniqueAspects } = analyzeRecords(records);
    document.getElementById('common-methods-count').textContent = commonMethods.length;
    document.getElementById('common-aspects-count').textContent = commonAspects.length;
    updateAnalysisResults(commonMethods, uniqueMethods, commonAspects, uniqueAspects);
    updateRecordsList(records);
  }
  function getTodaySubmissions(records){
    const today = new Date().toLocaleDateString('zh-CN');
    return records.filter(r=> (r.date||'') === today).length;
  }
  function analyzeRecords(records){
    const ms=[], as=[];
    records.forEach(r=>{ if(r.method) ms.push(String(r.method)); if(r.aspect) as.push(String(r.aspect)); });
    const mc = countAndGroupSimilarItems(ms), ac = countAndGroupSimilarItems(as);
    const commonMethods = Object.entries(mc).filter(([,c])=>c>=3).map(([item,count])=>({item,count}));
    const uniqueMethods = Object.entries(mc).filter(([,c])=>c<3).map(([item,count])=>({item,count}));
    const commonAspects = Object.entries(ac).filter(([,c])=>c>=3).map(([item,count])=>({item,count}));
    const uniqueAspects = Object.entries(ac).filter(([,c])=>c<3).map(([item,count])=>({item,count}));
    return { commonMethods, uniqueMethods, commonAspects, uniqueAspects };
  }
  function countAndGroupSimilarItems(items){
    const counts={};
    items.forEach(t=>{
      const n=t.trim().toLowerCase();
      let hit=false;
      for(const k in counts){ if(isSimilar(n,k)){ counts[k]++; hit=true; break; } }
      if(!hit) counts[n]=1;
    });
    return counts;
  }
  function isSimilar(a,b){ if(a===b) return true; if(a.includes(b)||b.includes(a)) return true;
    const d=lev(a,b), L=Math.max(a.length,b.length)||1; return d<=L/3; }
  function lev(a,b){ const m=[]; for(let i=0;i<=b.length;i++){ m[i]=[i]; } for(let j=0;j<=a.length;j++){ m[0][j]=j; }
    for(let i=1;i<=b.length;i++){ for(let j=1;j<=a.length;j++){
      m[i][j]=(b[i-1]===a[j-1])?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);
    }} return m[b.length][a.length]; }
  function updateAnalysisResults(cm,um,ca,ua){
    const set = (id, arr, cls, empty)=> {
      const c=document.getElementById(id); c.innerHTML = arr.length? '' : `<p style="color:#666;text-align:center;">${empty}</p>`;
      arr.forEach(x=>{ const el=document.createElement('div'); el.className=cls; el.textContent=`${x.item} (${x.count})`; 
        // 设置黑色字体和增大字号
        el.style.color = '#000000';
        el.style.fontSize = '25px'; // 可以根据需要调整大小，如14px、18px等
        c.appendChild(el); });
    };
    set('common-methods', cm, 'common-item', '暂无共性方法');
    set('unique-methods', um, 'unique-item', '暂无个性方法');
    set('common-aspects', ca, 'common-item', '暂无共性特征');
    set('unique-aspects', ua, 'unique-item', '暂无个性特征');
  }
  function updateRecordsList(records){
    const c=document.getElementById('records-container'); c.innerHTML='';
    const sorted=[...records].sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).slice(0,10);
    if(!sorted.length){ c.innerHTML='<p style="text-align:center;padding:20px;">暂无学生提交记录</p>'; return; }
    sorted.forEach(r=>{
      const el=document.createElement('div'); el.className='record-item';
      el.innerHTML=`
        <div class="record-date"><strong>提交时间:</strong> ${r.date||'—'}</div>
        <div class="record-methods"><strong>观察方法:</strong> ${escapeHtml(r.method||'')}</div>
        <div class="record-aspects"><strong>观察特征:</strong> ${escapeHtml(r.aspect||'')}</div>`;
      c.appendChild(el);
    });
    if(records.length>10){
      const more=document.createElement('div'); more.className='record-item'; more.style.textAlign='center'; more.style.color='#666';
      more.textContent=`还有 ${records.length-10} 条记录未显示`; c.appendChild(more);
    }
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function showStatus(msg,type){ clearStatus(); const el=document.createElement('div'); el.className=`status-message ${type}`; el.textContent=msg; el.id='status-message';
    document.querySelector('.container').insertBefore(el, document.querySelector('.tab-container')); }
  function clearStatus(){ const el=document.getElementById('status-message'); if(el) el.remove(); }
</script>

</body>
</html>


